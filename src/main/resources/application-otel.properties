# Sprint 18: OpenTelemetry Distributed Tracing Configuration for Quarkus
# Enables end-to-end tracing across consensus consensus boundaries and transactions

# ========== OpenTelemetry SDK Configuration ==========
quarkus.otel.sdk.disabled=false
quarkus.otel.enabled=true
quarkus.otel.traces.enabled=true
quarkus.otel.metrics.enabled=true
quarkus.otel.logs.enabled=true

# ========== OpenTelemetry Resource Attributes ==========
quarkus.otel.resource.attributes=\
  service.name=aurigraph-v11,\
  service.version=11.0.0,\
  service.namespace=aurigraph,\
  deployment.environment=production,\
  cluster.name=aurigraph-cluster,\
  telemetry.sdk.language=java

# ========== Traces Configuration ==========
quarkus.otel.traces.sampler=jaeger_remote
quarkus.otel.traces.sampler.jaeger.remote.endpoint=http://otel-collector:14250

# Trace exporter
quarkus.otel.exporter.otlp.enabled=true
quarkus.otel.exporter.otlp.traces.endpoint=https://otel-collector:4317
quarkus.otel.exporter.otlp.traces.protocol=grpc
quarkus.otel.exporter.otlp.traces.insecure=false
quarkus.otel.exporter.otlp.traces.timeout=30s

# TLS Configuration for traces
quarkus.otel.exporter.otlp.traces.certificate=/opt/certs/ca.crt
quarkus.otel.exporter.otlp.traces.client-certificate=/opt/certs/node-client.crt
quarkus.otel.exporter.otlp.traces.client-key=/opt/certs/node-client.key

# Traces batch export
quarkus.otel.bsp.schedule_delay=5000
quarkus.otel.bsp.max_queue_size=2048
quarkus.otel.bsp.max_export_batch_size=512
quarkus.otel.bsp.export_timeout=30000

# ========== Metrics Configuration ==========
quarkus.otel.metrics.enabled=true
quarkus.otel.metrics.exporter=otlp
quarkus.otel.exporter.otlp.metrics.endpoint=https://otel-collector:4317
quarkus.otel.exporter.otlp.metrics.protocol=grpc
quarkus.otel.exporter.otlp.metrics.insecure=false
quarkus.otel.exporter.otlp.metrics.interval=60000

# TLS for metrics
quarkus.otel.exporter.otlp.metrics.certificate=/opt/certs/ca.crt

# ========== Logs Configuration ==========
quarkus.otel.logs.enabled=true
quarkus.otel.logs.exporter=otlp
quarkus.otel.exporter.otlp.logs.endpoint=https://otel-collector:4317
quarkus.otel.exporter.otlp.logs.protocol=grpc
quarkus.otel.exporter.otlp.logs.insecure=false

# ========== Instrumentation ==========
# Automatic instrumentation for common libraries
quarkus.otel.instrumentation.enabled=true

# HTTP Instrumentation
quarkus.otel.instrumentation.http.enabled=true
quarkus.otel.instrumentation.http.server.enabled=true
quarkus.otel.instrumentation.http.client.enabled=true
quarkus.otel.instrumentation.http.server.request-headers-to-capture=\
  authorization,x-request-id,x-b3-traceid,traceparent
quarkus.otel.instrumentation.http.server.response-headers-to-capture=\
  content-type,content-length

# gRPC Instrumentation
quarkus.otel.instrumentation.grpc.enabled=true

# Database Instrumentation
quarkus.otel.instrumentation.jdbc.enabled=true
quarkus.otel.instrumentation.jdbc.statement-sanitizer.enabled=true

# Redis Instrumentation
quarkus.otel.instrumentation.redis.enabled=true

# Kafka Instrumentation (if using Kafka)
quarkus.otel.instrumentation.kafka.enabled=true

# ========== Jaeger Specific Configuration ==========
quarkus.jaeger.enabled=true
quarkus.jaeger.service-name=aurigraph-v11
quarkus.jaeger.sampler.type=const
quarkus.jaeger.sampler.param=1
quarkus.jaeger.endpoint=https://jaeger:14250/api/traces
quarkus.jaeger.tls.enabled=true
quarkus.jaeger.tls.skip-verify=false

# ========== Trace Context Propagation ==========
# W3C Trace Context (default)
quarkus.otel.propagators=jaeger,b3multi,tracecontext

# Custom propagation for consensus
quarkus.otel.propagation.aurigraph.enabled=true

# ========== Baggage Configuration ==========
# Propagate consensus context through baggage
quarkus.otel.baggage.enabled=true
quarkus.otel.baggage.context.propagators=jaeger

# ========== Span Processor Configuration ==========
# Batch span processor (recommended for production)
quarkus.otel.span.processor=batch

# ========== Sampling Configuration ==========
# Sample 100% of traces for consensus operations
# (normally 10% for cost optimization, but 100% for critical consensus)
quarkus.otel.sampler.parent-based.root-sampler=always_on

# Always sample errors
quarkus.otel.sampler.parent-based.remote-parent-not-sampled-sampler=always_off
quarkus.otel.sampler.parent-based.remote-parent-sampled-sampler=always_on

# ========== Consensus-Specific Tracing ==========
# Tag consensus voting rounds
quarkus.application.consensus.tracing.enabled=true
quarkus.application.consensus.tracing.include-payloads=false
quarkus.application.consensus.tracing.sample-rate=1.0

# Tag transaction submissions
quarkus.application.transaction.tracing.enabled=true
quarkus.application.transaction.tracing.sample-rate=0.1

# Tag failover events
quarkus.application.failover.tracing.enabled=true
quarkus.application.failover.tracing.sample-rate=1.0

# ========== Performance Tuning ==========
# Memory management for tracer
quarkus.otel.sdk.trace.memory.max-queue-size=2048
quarkus.otel.sdk.trace.memory.max-export-batch-size=512

# Thread management
quarkus.otel.sdk.trace.thread-pool.size=4
quarkus.otel.sdk.trace.thread-pool.queue-size=2048

# ========== Debug Configuration ==========
# Enable detailed logging for debugging (uncomment)
# quarkus.log.category."io.opentelemetry".level=DEBUG
# quarkus.log.category."io.opentelemetry.sdk".level=DEBUG
# quarkus.log.category."io.opentelemetry.exporter".level=DEBUG

# ========== Custom Instrumentation ==========
# Enable custom span creation in application code
quarkus.application.tracing.custom-spans.enabled=true

# Consensus voting round spans
quarkus.application.consensus.voting.span-enabled=true

# Transaction processing spans
quarkus.application.transaction.processing.span-enabled=true

# Leader election spans
quarkus.application.consensus.election.span-enabled=true

# ========== Metrics ==========
# Export application metrics
quarkus.micrometer.export.otlp.enabled=true
quarkus.micrometer.export.otlp.endpoint=https://otel-collector:4317
quarkus.micrometer.export.otlp.step=1m

# Consensus metrics
quarkus.application.consensus.metrics.enabled=true
quarkus.application.consensus.metrics.include-finality=true
quarkus.application.consensus.metrics.include-latency=true

# Transaction metrics
quarkus.application.transaction.metrics.enabled=true
quarkus.application.transaction.metrics.include-tps=true
quarkus.application.transaction.metrics.include-error-rate=true

# ========== Logging Integration ==========
# Correlate logs with traces
quarkus.log.console.json=true
quarkus.log.console.json.additional-field.trace_id.value=%X{trace_id}
quarkus.log.console.json.additional-field.span_id.value=%X{span_id}
quarkus.log.console.json.additional-field.trace_flags.value=%X{trace_flags}
