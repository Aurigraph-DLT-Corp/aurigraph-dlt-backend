#!/bin/bash\n# Aurigraph V11 Complete Production Deployment Script\n# Deploys the entire production infrastructure with zero-downtime rolling updates\n\nset -euo pipefail\n\n# =============================================================================\n# Configuration and Environment Variables\n# =============================================================================\n\nSCRIPT_DIR=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\nPROJECT_ROOT=\"$(dirname \"$SCRIPT_DIR\")\"\nTIMESTAMP=\"$(date '+%Y%m%d-%H%M%S')\"\nDEPLOYMENT_LOG=\"${PROJECT_ROOT}/logs/deployment-${TIMESTAMP}.log\"\n\n# Create logs directory if it doesn't exist\nmkdir -p \"${PROJECT_ROOT}/logs\"\n\n# Deployment configuration\nNAMESPACE=\"aurigraph-production\"\nDEPLOYMENT_NAME=\"aurigraph-v11-production\"\nIMAGE_TAG=\"${IMAGE_TAG:-latest}\"\nBUILD_TYPE=\"${BUILD_TYPE:-native-ultra}\"\nKUBE_CONTEXT=\"${KUBE_CONTEXT:-production}\"\nREGISTRY=\"${CONTAINER_REGISTRY:-aurigraph}\"\n\n# Performance targets\nTARGET_TPS=\"2000000\"\nMAX_LATENCY_MS=\"50\"\nMAX_REPLICAS=\"50\"\nMIN_REPLICAS=\"5\"\n\n# Timeout values\nDEPLOY_TIMEOUT=\"900\"  # 15 minutes\nHEALTH_CHECK_TIMEOUT=\"300\"  # 5 minutes\nROLLOUT_TIMEOUT=\"600\"  # 10 minutes\n\n# Colors for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\n# =============================================================================\n# Logging Functions\n# =============================================================================\n\nlog_info() {\n    echo -e \"${BLUE}[INFO]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*\" | tee -a \"$DEPLOYMENT_LOG\"\n}\n\nlog_success() {\n    echo -e \"${GREEN}[SUCCESS]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*\" | tee -a \"$DEPLOYMENT_LOG\"\n}\n\nlog_warn() {\n    echo -e \"${YELLOW}[WARN]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*\" | tee -a \"$DEPLOYMENT_LOG\"\n}\n\nlog_error() {\n    echo -e \"${RED}[ERROR]${NC} $(date '+%Y-%m-%d %H:%M:%S') - $*\" | tee -a \"$DEPLOYMENT_LOG\"\n}\n\n# =============================================================================\n# Utility Functions\n# =============================================================================\n\ncheck_prerequisites() {\n    log_info \"Checking deployment prerequisites...\"\n    \n    # Check required commands\n    local required_commands=(\"kubectl\" \"docker\" \"helm\" \"jq\" \"curl\")\n    for cmd in \"${required_commands[@]}\"; do\n        if ! command -v \"$cmd\" &> /dev/null; then\n            log_error \"Required command '$cmd' not found\"\n            exit 1\n        fi\n    done\n    \n    # Check Kubernetes context\n    if ! kubectl config get-contexts \"$KUBE_CONTEXT\" &> /dev/null; then\n        log_error \"Kubernetes context '$KUBE_CONTEXT' not found\"\n        exit 1\n    fi\n    \n    # Switch to production context\n    kubectl config use-context \"$KUBE_CONTEXT\"\n    \n    # Verify cluster connectivity\n    if ! kubectl cluster-info &> /dev/null; then\n        log_error \"Cannot connect to Kubernetes cluster\"\n        exit 1\n    fi\n    \n    # Check Docker registry access\n    if ! docker info &> /dev/null; then\n        log_error \"Cannot connect to Docker daemon\"\n        exit 1\n    fi\n    \n    log_success \"All prerequisites checked successfully\"\n}\n\ncreate_namespace() {\n    log_info \"Creating/updating namespace '$NAMESPACE'...\"\n    \n    kubectl apply -f - <<EOF\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: $NAMESPACE\n  labels:\n    name: $NAMESPACE\n    app: aurigraph-v11\n    tier: production\n    security.istio.io/tlsMode: istio\n  annotations:\n    scheduler.alpha.kubernetes.io/node-selector: \"node-type=high-performance\"\n    linkerd.io/inject: enabled\nEOF\n    \n    log_success \"Namespace '$NAMESPACE' ready\"\n}\n\nbuild_and_push_image() {\n    log_info \"Building and pushing Aurigraph V11 $BUILD_TYPE image...\"\n    \n    local image_name=\"${REGISTRY}/v11-${BUILD_TYPE}:${IMAGE_TAG}\"\n    local build_start=$(date +%s)\n    \n    # Build the Docker image\n    log_info \"Building Docker image: $image_name\"\n    docker build \\\n        --file \"${PROJECT_ROOT}/Dockerfile.production\" \\\n        --build-arg BUILD_TYPE=\"$BUILD_TYPE\" \\\n        --build-arg JAVA_VERSION=21 \\\n        --tag \"$image_name\" \\\n        --target \"${BUILD_TYPE}-production\" \\\n        \"$PROJECT_ROOT\" | tee -a \"$DEPLOYMENT_LOG\"\n    \n    # Push to registry\n    log_info \"Pushing image to registry: $image_name\"\n    docker push \"$image_name\" | tee -a \"$DEPLOYMENT_LOG\"\n    \n    local build_end=$(date +%s)\n    local build_duration=$((build_end - build_start))\n    \n    log_success \"Image built and pushed successfully in ${build_duration}s: $image_name\"\n    echo \"$image_name\"\n}\n\ndeploy_secrets() {\n    log_info \"Deploying production secrets...\"\n    \n    # Create registry secret if it doesn't exist\n    if ! kubectl get secret aurigraph-production-registry-secret -n \"$NAMESPACE\" &> /dev/null; then\n        log_info \"Creating container registry secret...\"\n        kubectl create secret docker-registry aurigraph-production-registry-secret \\\n            --docker-server=\"$CONTAINER_REGISTRY_SERVER\" \\\n            --docker-username=\"$CONTAINER_REGISTRY_USERNAME\" \\\n            --docker-password=\"$CONTAINER_REGISTRY_PASSWORD\" \\\n            --docker-email=\"$CONTAINER_REGISTRY_EMAIL\" \\\n            -n \"$NAMESPACE\"\n    fi\n    \n    # Apply production secrets\n    kubectl apply -f \"${PROJECT_ROOT}/k8s/production-deployment-complete.yaml\" -n \"$NAMESPACE\" | grep -E \"secret.*configured|secret.*created\"\n    \n    log_success \"Production secrets deployed successfully\"\n}\n\ndeploy_infrastructure() {\n    log_info \"Deploying production infrastructure components...\"\n    \n    # Deploy in order: ConfigMaps, PVCs, Services, then Deployments\n    local components=(\"configmap\" \"persistentvolumeclaim\" \"service\" \"deployment\")\n    \n    for component in \"${components[@]}\"; do\n        log_info \"Deploying $component resources...\"\n        kubectl apply -f \"${PROJECT_ROOT}/k8s/production-deployment-complete.yaml\" -n \"$NAMESPACE\" | grep \"$component\"\n    done\n    \n    # Deploy HPA and monitoring\n    log_info \"Deploying autoscaling and monitoring components...\"\n    kubectl apply -f \"${PROJECT_ROOT}/k8s/production-hpa-advanced.yaml\" -n \"$NAMESPACE\"\n    \n    log_success \"Infrastructure components deployed successfully\"\n}\n\nupdate_deployment_image() {\n    local image_name=\"$1\"\n    log_info \"Updating deployment with new image: $image_name\"\n    \n    # Update the deployment with new image\n    kubectl set image deployment/$DEPLOYMENT_NAME \\\n        aurigraph-v11-production=\"$image_name\" \\\n        -n \"$NAMESPACE\"\n    \n    # Add deployment annotations\n    kubectl annotate deployment/$DEPLOYMENT_NAME \\\n        deployment.kubernetes.io/change-cause=\"Production deployment - Image: $image_name - Time: $(date)\" \\\n        deployment.kubernetes.io/revision=\"$(date +%s)\" \\\n        aurigraph.io/deployment-timestamp=\"$TIMESTAMP\" \\\n        aurigraph.io/target-tps=\"$TARGET_TPS\" \\\n        -n \"$NAMESPACE\" --overwrite\n    \n    log_success \"Deployment updated with new image\"\n}\n\nwait_for_rollout() {\n    log_info \"Waiting for deployment rollout to complete...\"\n    \n    local rollout_start=$(date +%s)\n    \n    if kubectl rollout status deployment/$DEPLOYMENT_NAME \\\n        -n \"$NAMESPACE\" \\\n        --timeout=\"${ROLLOUT_TIMEOUT}s\"; then\n        \n        local rollout_end=$(date +%s)\n        local rollout_duration=$((rollout_end - rollout_start))\n        \n        log_success \"Deployment rollout completed successfully in ${rollout_duration}s\"\n    else\n        log_error \"Deployment rollout failed or timed out\"\n        return 1\n    fi\n}\n\nverify_deployment() {\n    log_info \"Verifying deployment health and performance...\"\n    \n    # Wait for pods to be ready\n    log_info \"Waiting for pods to become ready...\"\n    kubectl wait --for=condition=ready pod \\\n        -l app=aurigraph-v11 \\\n        -n \"$NAMESPACE\" \\\n        --timeout=\"${HEALTH_CHECK_TIMEOUT}s\"\n    \n    # Get deployment status\n    local ready_replicas\n    ready_replicas=$(kubectl get deployment $DEPLOYMENT_NAME -n \"$NAMESPACE\" -o jsonpath='{.status.readyReplicas}')\n    local desired_replicas\n    desired_replicas=$(kubectl get deployment $DEPLOYMENT_NAME -n \"$NAMESPACE\" -o jsonpath='{.spec.replicas}')\n    \n    if [[ \"$ready_replicas\" -eq \"$desired_replicas\" ]]; then\n        log_success \"All $ready_replicas/$desired_replicas replicas are ready\"\n    else\n        log_error \"Only $ready_replicas/$desired_replicas replicas are ready\"\n        return 1\n    fi\n    \n    # Test health endpoints\n    log_info \"Testing application health endpoints...\"\n    local service_ip\n    service_ip=$(kubectl get service aurigraph-v11-production-service -n \"$NAMESPACE\" -o jsonpath='{.status.loadBalancer.ingress[0].ip}')\n    \n    if [[ -n \"$service_ip\" ]]; then\n        # Test health endpoint\n        if curl -sf \"http://$service_ip:9003/q/health\" > /dev/null; then\n            log_success \"Health endpoint responding correctly\"\n        else\n            log_warn \"Health endpoint test failed - service may still be starting\"\n        fi\n        \n        # Test performance endpoint\n        if curl -sf \"http://$service_ip:9003/api/v11/performance\" > /dev/null; then\n            log_success \"Performance endpoint responding correctly\"\n        else\n            log_warn \"Performance endpoint test failed\"\n        fi\n    else\n        log_warn \"Load balancer IP not yet assigned - skipping external health checks\"\n    fi\n    \n    log_success \"Deployment verification completed\"\n}\n\nperformance_validation() {\n    log_info \"Running performance validation tests...\"\n    \n    local validation_start=$(date +%s)\n    \n    # Run internal performance test\n    log_info \"Executing performance validation...\"\n    kubectl exec -n \"$NAMESPACE\" \\\n        deployment/$DEPLOYMENT_NAME \\\n        -c aurigraph-v11-production \\\n        -- curl -sf http://localhost:9003/api/v11/performance || {\n        log_warn \"Performance validation failed - may need warm-up time\"\n    }\n    \n    # Check HPA metrics\n    log_info \"Checking HPA metrics and scaling capability...\"\n    kubectl get hpa aurigraph-v11-production-hpa -n \"$NAMESPACE\" -o wide\n    \n    # Monitor for initial TPS\n    log_info \"Monitoring initial TPS performance...\"\n    sleep 30  # Allow warm-up time\n    \n    local validation_end=$(date +%s)\n    local validation_duration=$((validation_end - validation_start))\n    \n    log_success \"Performance validation completed in ${validation_duration}s\"\n}\n\ngenerate_deployment_report() {\n    log_info \"Generating deployment report...\"\n    \n    local report_file=\"${PROJECT_ROOT}/logs/deployment-report-${TIMESTAMP}.json\"\n    \n    # Collect deployment information\n    local deployment_info\n    deployment_info=$(kubectl get deployment $DEPLOYMENT_NAME -n \"$NAMESPACE\" -o json)\n    \n    local hpa_info\n    hpa_info=$(kubectl get hpa aurigraph-v11-production-hpa -n \"$NAMESPACE\" -o json 2>/dev/null || echo '{}')\n    \n    local pods_info\n    pods_info=$(kubectl get pods -l app=aurigraph-v11 -n \"$NAMESPACE\" -o json)\n    \n    # Generate report\n    cat > \"$report_file\" <<EOF\n{\n  \"deployment\": {\n    \"timestamp\": \"$TIMESTAMP\",\n    \"namespace\": \"$NAMESPACE\",\n    \"deployment_name\": \"$DEPLOYMENT_NAME\",\n    \"image_tag\": \"$IMAGE_TAG\",\n    \"build_type\": \"$BUILD_TYPE\",\n    \"target_tps\": \"$TARGET_TPS\",\n    \"kube_context\": \"$KUBE_CONTEXT\"\n  },\n  \"kubernetes\": {\n    \"deployment\": $deployment_info,\n    \"hpa\": $hpa_info,\n    \"pods\": $pods_info\n  },\n  \"performance\": {\n    \"target_tps\": $TARGET_TPS,\n    \"max_latency_ms\": $MAX_LATENCY_MS,\n    \"min_replicas\": $MIN_REPLICAS,\n    \"max_replicas\": $MAX_REPLICAS\n  }\n}\nEOF\n    \n    log_success \"Deployment report generated: $report_file\"\n}\n\ncleanup_old_resources() {\n    log_info \"Cleaning up old deployment resources...\"\n    \n    # Clean up old ReplicaSets (keep last 5)\n    local old_replicasets\n    old_replicasets=$(kubectl get rs -n \"$NAMESPACE\" -l app=aurigraph-v11 --sort-by=.metadata.creationTimestamp -o name | head -n -5)\n    \n    if [[ -n \"$old_replicasets\" ]]; then\n        log_info \"Removing old ReplicaSets: $old_replicasets\"\n        echo \"$old_replicasets\" | xargs -r kubectl delete -n \"$NAMESPACE\"\n    fi\n    \n    # Clean up old deployment logs (keep last 10)\n    find \"${PROJECT_ROOT}/logs\" -name \"deployment-*.log\" -type f | sort -r | tail -n +11 | xargs -r rm -f\n    \n    log_success \"Old resources cleaned up\"\n}\n\nnotify_completion() {\n    local status=\"$1\"\n    local message=\"$2\"\n    \n    log_info \"Sending deployment notification...\"\n    \n    # Send Slack notification if webhook is configured\n    if [[ -n \"${SLACK_WEBHOOK_URL:-}\" ]]; then\n        local color=\"good\"\n        [[ \"$status\" != \"success\" ]] && color=\"danger\"\n        \n        curl -X POST -H 'Content-type: application/json' \\\n            --data '{\n                \"attachments\": [{\n                    \"color\": \"'$color'\",\n                    \"title\": \"Aurigraph V11 Production Deployment\",\n                    \"text\": \"'$message'\",\n                    \"fields\": [\n                        {\"title\": \"Environment\", \"value\": \"Production\", \"short\": true},\n                        {\"title\": \"Namespace\", \"value\": \"'$NAMESPACE'\", \"short\": true},\n                        {\"title\": \"Build Type\", \"value\": \"'$BUILD_TYPE'\", \"short\": true},\n                        {\"title\": \"Target TPS\", \"value\": \"'$TARGET_TPS'\", \"short\": true}\n                    ],\n                    \"footer\": \"Aurigraph V11 Deployment\",\n                    \"ts\": '$(date +%s)'\n                }]\n            }' \\\n            \"$SLACK_WEBHOOK_URL\"\n    fi\n    \n    # Send email notification if configured\n    if [[ -n \"${SMTP_ENABLED:-}\" ]] && [[ \"$SMTP_ENABLED\" == \"true\" ]]; then\n        echo \"$message\" | mail -s \"Aurigraph V11 Production Deployment - $status\" \"$NOTIFICATION_EMAIL\"\n    fi\n}\n\n# =============================================================================\n# Error Handling and Rollback\n# =============================================================================\n\nrollback_deployment() {\n    log_error \"Deployment failed - initiating rollback...\"\n    \n    # Get previous revision\n    local previous_revision\n    previous_revision=$(kubectl rollout history deployment/$DEPLOYMENT_NAME -n \"$NAMESPACE\" --revision=0 | tail -2 | head -1 | awk '{print $1}')\n    \n    if [[ -n \"$previous_revision\" ]] && [[ \"$previous_revision\" =~ ^[0-9]+$ ]]; then\n        log_info \"Rolling back to revision $previous_revision\"\n        kubectl rollout undo deployment/$DEPLOYMENT_NAME -n \"$NAMESPACE\" --to-revision=\"$previous_revision\"\n        \n        # Wait for rollback to complete\n        if kubectl rollout status deployment/$DEPLOYMENT_NAME -n \"$NAMESPACE\" --timeout=\"${ROLLOUT_TIMEOUT}s\"; then\n            log_success \"Rollback completed successfully\"\n            notify_completion \"rollback\" \"Production deployment failed and was rolled back to revision $previous_revision\"\n        else\n            log_error \"Rollback failed - manual intervention required\"\n            notify_completion \"rollback-failed\" \"Production deployment and rollback both failed - immediate attention required\"\n        fi\n    else\n        log_error \"No previous revision found - manual intervention required\"\n        notify_completion \"rollback-failed\" \"Production deployment failed and no rollback available - immediate attention required\"\n    fi\n}\n\nhandle_error() {\n    local exit_code=$?\n    log_error \"Deployment script failed with exit code $exit_code\"\n    \n    # Capture deployment state for debugging\n    kubectl get all -n \"$NAMESPACE\" -o wide > \"${PROJECT_ROOT}/logs/error-state-${TIMESTAMP}.log\" 2>&1\n    kubectl describe deployment $DEPLOYMENT_NAME -n \"$NAMESPACE\" >> \"${PROJECT_ROOT}/logs/error-state-${TIMESTAMP}.log\" 2>&1\n    \n    # Attempt rollback\n    rollback_deployment\n    \n    exit $exit_code\n}\n\n# Set up error handling\ntrap handle_error ERR\n\n# =============================================================================\n# Main Deployment Process\n# =============================================================================\n\nmain() {\n    log_info \"Starting Aurigraph V11 Production Deployment\"\n    log_info \"Timestamp: $TIMESTAMP\"\n    log_info \"Build Type: $BUILD_TYPE\"\n    log_info \"Image Tag: $IMAGE_TAG\"\n    log_info \"Target TPS: $TARGET_TPS\"\n    log_info \"Kubernetes Context: $KUBE_CONTEXT\"\n    log_info \"Namespace: $NAMESPACE\"\n    \n    local deployment_start=$(date +%s)\n    \n    # Pre-deployment checks\n    check_prerequisites\n    create_namespace\n    \n    # Build and push new image\n    local image_name\n    image_name=$(build_and_push_image)\n    \n    # Deploy infrastructure components\n    deploy_secrets\n    deploy_infrastructure\n    \n    # Update deployment with new image\n    update_deployment_image \"$image_name\"\n    \n    # Wait for rollout and verify\n    wait_for_rollout\n    verify_deployment\n    \n    # Performance validation\n    performance_validation\n    \n    # Post-deployment tasks\n    generate_deployment_report\n    cleanup_old_resources\n    \n    local deployment_end=$(date +%s)\n    local deployment_duration=$((deployment_end - deployment_start))\n    \n    log_success \"Production deployment completed successfully in ${deployment_duration}s\"\n    log_success \"Image deployed: $image_name\"\n    log_success \"Namespace: $NAMESPACE\"\n    log_success \"Target TPS: $TARGET_TPS\"\n    log_success \"Log file: $DEPLOYMENT_LOG\"\n    \n    # Send success notification\n    notify_completion \"success\" \"Production deployment completed successfully in ${deployment_duration}s with image: $image_name\"\n    \n    # Display deployment summary\n    echo -e \"\\n${GREEN}=== Deployment Summary ===${NC}\"\n    kubectl get deployment $DEPLOYMENT_NAME -n \"$NAMESPACE\" -o wide\n    echo -e \"\\n${GREEN}=== Pod Status ===${NC}\"\n    kubectl get pods -l app=aurigraph-v11 -n \"$NAMESPACE\" -o wide\n    echo -e \"\\n${GREEN}=== Service Status ===${NC}\"\n    kubectl get service aurigraph-v11-production-service -n \"$NAMESPACE\" -o wide\n    echo -e \"\\n${GREEN}=== HPA Status ===${NC}\"\n    kubectl get hpa aurigraph-v11-production-hpa -n \"$NAMESPACE\" -o wide\n}\n\n# =============================================================================\n# Script Entry Point\n# =============================================================================\n\nif [[ \"${BASH_SOURCE[0]}\" == \"${0}\" ]]; then\n    # Parse command line arguments\n    while [[ $# -gt 0 ]]; do\n        case $1 in\n            --build-type)\n                BUILD_TYPE=\"$2\"\n                shift 2\n                ;;\n            --image-tag)\n                IMAGE_TAG=\"$2\"\n                shift 2\n                ;;\n            --namespace)\n                NAMESPACE=\"$2\"\n                shift 2\n                ;;\n            --context)\n                KUBE_CONTEXT=\"$2\"\n                shift 2\n                ;;\n            --target-tps)\n                TARGET_TPS=\"$2\"\n                shift 2\n                ;;\n            --help)\n                echo \"Usage: $0 [options]\"\n                echo \"Options:\"\n                echo \"  --build-type TYPE    Build type: jvm, native-fast, native-standard, native-ultra (default: native-ultra)\"\n                echo \"  --image-tag TAG      Image tag (default: latest)\"\n                echo \"  --namespace NS       Kubernetes namespace (default: aurigraph-production)\"\n                echo \"  --context CTX        Kubernetes context (default: production)\"\n                echo \"  --target-tps TPS     Target TPS (default: 2000000)\"\n                echo \"  --help               Show this help message\"\n                exit 0\n                ;;\n            *)\n                log_error \"Unknown option: $1\"\n                exit 1\n                ;;\n        esac\n    done\n    \n    main \"$@\"\nfi\n"