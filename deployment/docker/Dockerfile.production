# Multi-stage Dockerfile for Aurigraph V11 Production Deployment\n# Supports both JVM and Native builds with optimized layers\n\n# Build argument to control build type\nARG BUILD_TYPE=native-ultra\nARG JAVA_VERSION=21\nARG MAVEN_VERSION=3.9.6\nARG BASE_IMAGE=registry.access.redhat.com/ubi9/ubi-minimal:latest\n\n# =============================================================================\n# Stage 1: Build Environment Setup\n# =============================================================================\nFROM quay.io/quarkus/ubi-quarkus-native-image:23.0-java${JAVA_VERSION} AS build-env\n\n# Install build dependencies\nUSER root\nRUN microdnf update -y && \\\n    microdnf install -y \\\n        git \\\n        findutils \\\n        curl \\\n        wget \\\n        tar \\\n        gzip \\\n        which && \\\n    microdnf clean all\n\n# Set build environment variables\nENV MAVEN_OPTS=\"-Xmx6g -XX:+UseParallelGC -XX:MaxMetaspaceSize=1g\"\nENV GRAALVM_HOME=/opt/graalvm\nENV JAVA_HOME=/opt/graalvm\nENV PATH=\"/opt/graalvm/bin:$PATH\"\n\n# Optimize native image build environment\nENV NATIVE_IMAGE_XMX=8g\nENV NATIVE_IMAGE_OPTS=\"-H:+UnlockExperimentalVMOptions -H:+UseContainerSupport -H:MaxRAMPercentage=80.0\"\n\n# =============================================================================\n# Stage 2: Maven Dependencies Cache\n# =============================================================================\nFROM build-env AS dependencies\n\nUSER quarkus\nWORKDIR /code\n\n# Copy Maven configuration first for better layer caching\nCOPY --chown=quarkus:quarkus pom.xml ./\nCOPY --chown=quarkus:quarkus mvnw ./\nCOPY --chown=quarkus:quarkus mvnw.cmd ./\nCOPY --chown=quarkus:quarkus .mvn .mvn\n\n# Download dependencies only (better Docker layer caching)\nRUN ./mvnw dependency:go-offline -B -q\n\n# =============================================================================\n# Stage 3: Application Source Build\n# =============================================================================\nFROM dependencies AS source-build\n\n# Copy source code\nCOPY --chown=quarkus:quarkus src src/\nCOPY --chown=quarkus:quarkus *.properties ./\nCOPY --chown=quarkus:quarkus *.yaml ./\nCOPY --chown=quarkus:quarkus *.json ./\n\n# Build the application (compilation only)\nRUN ./mvnw clean compile -B -q -DskipTests\n\n# =============================================================================\n# Stage 4: JVM Build (Uber JAR)\n# =============================================================================\nFROM source-build AS jvm-build\n\n# Build uber JAR for JVM deployment\nRUN ./mvnw package -B -q -DskipTests -Dquarkus.package.jar.type=uber-jar\n\n# =============================================================================\n# Stage 5: Native Build - Fast Profile\n# =============================================================================\nFROM source-build AS native-fast-build\n\n# Build native binary with fast profile (development/testing)\nRUN ./mvnw package -B -q -DskipTests -Pnative-fast \\\n    -Dquarkus.native.container-build=false \\\n    -Dquarkus.native.builder-image=false \\\n    -Dquarkus.profile=prod\n\n# =============================================================================\n# Stage 6: Native Build - Standard Profile\n# =============================================================================\nFROM source-build AS native-standard-build\n\n# Build native binary with standard optimizations\nRUN ./mvnw package -B -q -DskipTests -Pnative \\\n    -Dquarkus.native.container-build=false \\\n    -Dquarkus.native.builder-image=false \\\n    -Dquarkus.profile=prod \\\n    -Dquarkus.native.additional-build-args=\"-H:+ReportExceptionStackTraces,-H:+PrintGCDetails,--gc=G1\"\n\n# =============================================================================\n# Stage 7: Native Build - Ultra Profile (Production)\n# =============================================================================\nFROM source-build AS native-ultra-build\n\n# Build native binary with ultra optimizations for production\nRUN ./mvnw package -B -q -DskipTests -Pnative-ultra \\\n    -Dquarkus.native.container-build=false \\\n    -Dquarkus.native.builder-image=false \\\n    -Dquarkus.profile=prod \\\n    -Dquarkus.native.additional-build-args=\"-H:+ReportExceptionStackTraces,-H:+PrintGCDetails,--gc=G1,-march=native,-mtune=native,--enable-preview\"\n\n# =============================================================================\n# Stage 8: Production Base Image\n# =============================================================================\nFROM ${BASE_IMAGE} AS production-base\n\n# Install runtime dependencies\nRUN microdnf update -y && \\\n    microdnf install -y \\\n        ca-certificates \\\n        tzdata \\\n        glibc-locale-source \\\n        glibc-langpack-en && \\\n    microdnf clean all\n\n# Create application user and directories\nRUN groupadd -r aurigraph --gid=1001 && \\\n    useradd -r -g aurigraph --uid=1001 --home-dir=/app --shell=/bin/bash aurigraph && \\\n    mkdir -p /app/{config,data,logs,secrets} && \\\n    chown -R aurigraph:aurigraph /app\n\n# Set timezone and locale\nENV TZ=UTC\nENV LANG=en_US.UTF-8\nENV LANGUAGE=en_US:en\nENV LC_ALL=en_US.UTF-8\n\n# Security and performance optimizations\nRUN echo 'aurigraph:!:$1$xyz$xyz:18500:0:99999:7:::' >> /etc/shadow && \\\n    echo 'aurigraph:x:1001:' >> /etc/group && \\\n    echo 'aurigraph:x:1001:1001:Aurigraph Application:/app:/bin/bash' >> /etc/passwd\n\n# =============================================================================\n# Stage 9: JVM Production Image\n# =============================================================================\nFROM production-base AS jvm-production\n\n# Install OpenJDK for JVM deployment\nRUN microdnf install -y java-${JAVA_VERSION}-openjdk-headless && microdnf clean all\n\n# Copy the uber JAR\nCOPY --from=jvm-build --chown=aurigraph:aurigraph /code/target/*-runner.jar /app/aurigraph-v11.jar\n\n# JVM tuning for production\nENV JAVA_OPTS=\"-Xms512m -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=1 -XX:G1HeapRegionSize=32m -XX:+UseStringDeduplication -XX:+OptimizeStringConcat -XX:+UseCompressedOops -XX:+UseCompressedClassPointers -Djava.net.preferIPv4Stack=true -Djava.awt.headless=true\"\nENV QUARKUS_PROFILE=prod\nENV PORT=9003\n\nUSER aurigraph\nWORKDIR /app\n\nHEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \\\n  CMD curl -f http://localhost:9003/q/health || exit 1\n\nEXPOSE 9003 9004\n\nCMD [\"java\", \"-jar\", \"/app/aurigraph-v11.jar\"]\n\n# =============================================================================\n# Stage 10: Native Fast Production Image\n# =============================================================================\nFROM production-base AS native-fast-production\n\n# Copy the native binary\nCOPY --from=native-fast-build --chown=aurigraph:aurigraph /code/target/*-runner /app/aurigraph-v11\n\n# Make binary executable\nRUN chmod +x /app/aurigraph-v11\n\n# Native binary environment\nENV QUARKUS_PROFILE=prod\nENV PORT=9003\nENV MALLOC_ARENA_MAX=1\nENV MALLOC_MMAP_THRESHOLD_=32768\n\nUSER aurigraph\nWORKDIR /app\n\nHEALTHCHECK --interval=15s --timeout=2s --start-period=2s --retries=3 \\\n  CMD curl -f http://localhost:9003/q/health || exit 1\n\nEXPOSE 9003 9004\n\nCMD [\"/app/aurigraph-v11\"]\n\n# =============================================================================\n# Stage 11: Native Standard Production Image\n# =============================================================================\nFROM production-base AS native-standard-production\n\n# Copy the native binary\nCOPY --from=native-standard-build --chown=aurigraph:aurigraph /code/target/*-runner /app/aurigraph-v11\n\n# Make binary executable\nRUN chmod +x /app/aurigraph-v11\n\n# Optimized native binary environment\nENV QUARKUS_PROFILE=prod\nENV PORT=9003\nENV MALLOC_ARENA_MAX=1\nENV MALLOC_MMAP_THRESHOLD_=32768\nENV MALLOC_TRIM_THRESHOLD_=131072\nENV MALLOC_TOP_PAD_=65536\n\nUSER aurigraph\nWORKDIR /app\n\nHEALTHCHECK --interval=15s --timeout=2s --start-period=2s --retries=3 \\\n  CMD curl -f http://localhost:9003/q/health || exit 1\n\nEXPOSE 9003 9004\n\nCMD [\"/app/aurigraph-v11\"]\n\n# =============================================================================\n# Stage 12: Native Ultra Production Image (Default)\n# =============================================================================\nFROM production-base AS native-ultra-production\n\n# Copy the ultra-optimized native binary\nCOPY --from=native-ultra-build --chown=aurigraph:aurigraph /code/target/*-runner /app/aurigraph-v11\n\n# Make binary executable\nRUN chmod +x /app/aurigraph-v11\n\n# Ultra-optimized native binary environment\nENV QUARKUS_PROFILE=prod\nENV PORT=9003\nENV MALLOC_ARENA_MAX=2\nENV MALLOC_MMAP_THRESHOLD_=65536\nENV MALLOC_TRIM_THRESHOLD_=131072\nENV MALLOC_TOP_PAD_=65536\nENV MALLOC_MMAP_MAX_=2048\n\n# Performance tuning environment variables\nENV AURIGRAPH_PRODUCTION_MODE=true\nENV AURIGRAPH_NATIVE_ULTRA_MODE=true\nENV PERFORMANCE_ULTRA_MODE=true\nENV NUMA_AWARE=true\n\nUSER aurigraph\nWORKDIR /app\n\nHEALTHCHECK --interval=10s --timeout=2s --start-period=1s --retries=3 \\\n  CMD curl -f http://localhost:9003/q/health/ready || exit 1\n\nEXPOSE 9003 9004 9005\n\nCMD [\"/app/aurigraph-v11\"]\n\n# =============================================================================\n# Final stage selection based on BUILD_TYPE argument\n# =============================================================================\nFROM ${BUILD_TYPE}-production AS final\n\n# Labels for image metadata\nLABEL org.opencontainers.image.title=\"Aurigraph V11 Production\"\nLABEL org.opencontainers.image.description=\"High-performance blockchain platform targeting 2M+ TPS\"\nLABEL org.opencontainers.image.version=\"11.0.0\"\nLABEL org.opencontainers.image.vendor=\"Aurigraph DLT Corp\"\nLABEL org.opencontainers.image.source=\"https://github.com/Aurigraph-DLT-Corp/Aurigraph-DLT\"\nLABEL org.opencontainers.image.documentation=\"https://docs.aurigraph.io/v11/deployment\"\nLABEL build.type=\"${BUILD_TYPE}\"\nLABEL java.version=\"${JAVA_VERSION}\"\n\n# Final configuration\nENV AURIGRAPH_VERSION=11.0.0\nENV AURIGRAPH_BUILD_TYPE=${BUILD_TYPE}\nENV CONTAINER_NAME=aurigraph-v11-production\n\n# Create build info file\nUSER root\nRUN echo \"Build Type: ${BUILD_TYPE}\" > /app/build-info.txt && \\\n    echo \"Java Version: ${JAVA_VERSION}\" >> /app/build-info.txt && \\\n    echo \"Build Date: $(date -u +'%Y-%m-%dT%H:%M:%SZ')\" >> /app/build-info.txt && \\\n    echo \"Image: aurigraph/v11-${BUILD_TYPE}:latest\" >> /app/build-info.txt && \\\n    chown aurigraph:aurigraph /app/build-info.txt\n\nUSER aurigraph\n"