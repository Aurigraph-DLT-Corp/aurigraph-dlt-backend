version: '3.9'

# Base Docker Compose Configuration for Aurigraph DLT Backend
# This file defines core services (database, cache, API) that all environments extend from
# Individual environments (dev, staging, production) extend this base and add their own overrides

services:
  # PostgreSQL Database - Primary data store for blockchain state, transactions, validators
  postgres:
    image: postgres:16-alpine
    container_name: aurigraph-postgres
    environment:
      POSTGRES_DB: aurigraph_v12
      POSTGRES_USER: aurigraph
      POSTGRES_PASSWORD: ${DB_PASSWORD:-aurigraph_dev_password}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aurigraph"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aurigraph-net
    restart: unless-stopped

  # Redis Cache - High-speed caching layer for transaction pool, consensus state
  redis:
    image: redis:7-alpine
    container_name: aurigraph-redis
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-aurigraph_dev_password}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aurigraph-net
    restart: unless-stopped

  # Aurigraph V12 Backend API - Main blockchain service
  backend-api:
    image: aurigraph-backend:latest
    container_name: aurigraph-backend-api
    build:
      context: ../..
      dockerfile: Dockerfile
      target: runtime
      args:
        JAVA_VERSION: 21
    environment:
      # Server Configuration
      QUARKUS_HTTP_PORT: 9003
      QUARKUS_HTTP_HOST: 0.0.0.0
      QUARKUS_HTTP_HTTP2: "true"
      QUARKUS_HTTP_CORS: "true"

      # Database Configuration
      QUARKUS_DATASOURCE_DB_KIND: postgresql
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres:5432/aurigraph_v12
      QUARKUS_DATASOURCE_USERNAME: aurigraph
      QUARKUS_DATASOURCE_PASSWORD: ${DB_PASSWORD:-aurigraph_dev_password}
      QUARKUS_DATASOURCE_JDBC_MAX_SIZE: 20

      # Redis Configuration
      QUARKUS_REDIS_HOSTS: redis://redis:6379
      QUARKUS_REDIS_PASSWORD: ${REDIS_PASSWORD:-aurigraph_dev_password}

      # Consensus Configuration
      AURIGRAPH_CONSENSUS_ALGORITHM: hyperraft++
      AURIGRAPH_CONSENSUS_TIMEOUT: 150
      AURIGRAPH_CONSENSUS_FINALITY: 500
      AURIGRAPH_CONSENSUS_MIN_VALIDATORS: 3

      # Performance Configuration
      AURIGRAPH_PERFORMANCE_TARGET_TPS: 2000000
      AURIGRAPH_PERFORMANCE_PARALLEL_THREADS: 256

      # Cryptography Configuration
      AURIGRAPH_CRYPTO_QUANTUM_LEVEL: 5
      AURIGRAPH_CRYPTO_SIGNATURE_ALGORITHM: CRYSTALS-Dilithium
      AURIGRAPH_CRYPTO_ENCRYPTION_ALGORITHM: CRYSTALS-Kyber

      # API Configuration
      QUARKUS_REST_PATH: /api/v12
      QUARKUS_OPENAPI_PATH: /q/openapi
      QUARKUS_SWAGGER_UI_PATH: /q/swagger-ui

      # Logging
      QUARKUS_LOG_LEVEL: INFO
      QUARKUS_LOG_CONSOLE_FORMAT: "%d{HH:mm:ss} %-5p [%c{2.}] %s%e%n"

      # Monitoring & Metrics
      QUARKUS_MICROMETER_ENABLED: "true"
      QUARKUS_MICROMETER_EXPORT_PROMETHEUS_ENABLED: "true"
    ports:
      - "9003:9003"  # HTTP/2 REST API
      - "9004:9004"  # gRPC (planned)
      - "9005:9005"  # WebSocket (planned)
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9003/q/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aurigraph-net
    restart: unless-stopped
    labels:
      - "com.aurigraph.service=backend-api"
      - "com.aurigraph.tier=application"

networks:
  aurigraph-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
